<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>5.2 Using Convnets With Small Datasets Local Modified | Code and Stats</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="5.2 Using Convnets With Small Datasets Local Modified" />
<meta name="author" content="Code And Stats" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="import keras keras.__version__" />
<meta property="og:description" content="import keras keras.__version__" />
<link rel="canonical" href="http://localhost:4000/2020/04/16/5.2-using-convnets-with-small-datasets-local-modified.html" />
<meta property="og:url" content="http://localhost:4000/2020/04/16/5.2-using-convnets-with-small-datasets-local-modified.html" />
<meta property="og:site_name" content="Code and Stats" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-16T00:00:00+02:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Code And Stats"},"headline":"5.2 Using Convnets With Small Datasets Local Modified","description":"import keras keras.__version__","datePublished":"2020-04-16T00:00:00+02:00","dateModified":"2020-04-16T00:00:00+02:00","@type":"BlogPosting","url":"http://localhost:4000/2020/04/16/5.2-using-convnets-with-small-datasets-local-modified.html","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/04/16/5.2-using-convnets-with-small-datasets-local-modified.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Code and Stats" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Code and Stats</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">5.2 Using Convnets With Small Datasets Local Modified</h1>
    <p class="post-meta"><time class="dt-published" datetime="2020-04-16T00:00:00+02:00" itemprop="datePublished">
        Apr 16, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">keras</span>
<span class="n">keras</span><span class="o">.</span><span class="n">__version__</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Using TensorFlow backend.
/anaconda3/lib/python3.7/site-packages/tensorflow/python/framework/dtypes.py:526: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_qint8 = np.dtype([("qint8", np.int8, 1)])
/anaconda3/lib/python3.7/site-packages/tensorflow/python/framework/dtypes.py:527: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_quint8 = np.dtype([("quint8", np.uint8, 1)])
/anaconda3/lib/python3.7/site-packages/tensorflow/python/framework/dtypes.py:528: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_qint16 = np.dtype([("qint16", np.int16, 1)])
/anaconda3/lib/python3.7/site-packages/tensorflow/python/framework/dtypes.py:529: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_quint16 = np.dtype([("quint16", np.uint16, 1)])
/anaconda3/lib/python3.7/site-packages/tensorflow/python/framework/dtypes.py:530: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  _np_qint32 = np.dtype([("qint32", np.int32, 1)])
/anaconda3/lib/python3.7/site-packages/tensorflow/python/framework/dtypes.py:535: FutureWarning: Passing (type, 1) or '1type' as a synonym of type is deprecated; in a future version of numpy, it will be understood as (type, (1,)) / '(1,)type'.
  np_resource = np.dtype([("resource", np.ubyte, 1)])





'2.3.1'
</code></pre></div></div>

<h1 id="52---using-convnets-with-small-datasets">5.2 - Using convnets with small datasets</h1>

<p>This notebook contains the code sample found in Chapter 5, Section 2 of <a href="https://www.manning.com/books/deep-learning-with-python?a_aid=keras&amp;a_bid=76564dff">Deep Learning with Python</a>. Note that the original text features far more content, in particular further explanations and figures: in this notebook, you will only find source code and related comments.</p>

<h2 id="training-a-convnet-from-scratch-on-a-small-dataset">Training a convnet from scratch on a small dataset</h2>

<p>Having to train an image classification model using only very little data is a common situation, which you likely encounter yourself in 
practice if you ever do computer vision in a professional context.</p>

<p>Having “few” samples can mean anywhere from a few hundreds to a few tens of thousands of images. As a practical example, we will focus on 
classifying images as “dogs” or “cats”, in a dataset containing 4000 pictures of cats and dogs (2000 cats, 2000 dogs). We will use 2000 
pictures for training, 1000 for validation, and finally 1000 for testing.</p>

<p>In this section, we will review one basic strategy to tackle this problem: training a new model from scratch on what little data we have. We 
will start by naively training a small convnet on our 2000 training samples, without any regularization, to set a baseline for what can be 
achieved. This will get us to a classification accuracy of 71%. At that point, our main issue will be overfitting. Then we will introduce 
<em>data augmentation</em>, a powerful technique for mitigating overfitting in computer vision. By leveraging data augmentation, we will improve 
our network to reach an accuracy of 82%.</p>

<p>In the next section, we will review two more essential techniques for applying deep learning to small datasets: <em>doing feature extraction 
with a pre-trained network</em> (this will get us to an accuracy of 90% to 93%), and <em>fine-tuning a pre-trained network</em> (this will get us to 
our final accuracy of 95%). Together, these three strategies – training a small model from scratch, doing feature extracting using a 
pre-trained model, and fine-tuning a pre-trained model – will constitute your future toolbox for tackling the problem of doing computer 
vision with small datasets.</p>

<h2 id="the-relevance-of-deep-learning-for-small-data-problems">The relevance of deep learning for small-data problems</h2>

<p>You will sometimes hear that deep learning only works when lots of data is available. This is in part a valid point: one fundamental 
characteristic of deep learning is that it is able to find interesting features in the training data on its own, without any need for manual 
feature engineering, and this can only be achieved when lots of training examples are available. This is especially true for problems where 
the input samples are very high-dimensional, like images.</p>

<p>However, what constitutes “lots” of samples is relative – relative to the size and depth of the network you are trying to train, for 
starters. It isn’t possible to train a convnet to solve a complex problem with just a few tens of samples, but a few hundreds can 
potentially suffice if the model is small and well-regularized and if the task is simple. 
Because convnets learn local, translation-invariant features, they are very 
data-efficient on perceptual problems. Training a convnet from scratch on a very small image dataset will still yield reasonable results 
despite a relative lack of data, without the need for any custom feature engineering. You will see this in action in this section.</p>

<p>But what’s more, deep learning models are by nature highly repurposable: you can take, say, an image classification or speech-to-text model 
trained on a large-scale dataset then reuse it on a significantly different problem with only minor changes. Specifically, in the case of 
computer vision, many pre-trained models (usually trained on the ImageNet dataset) are now publicly available for download and can be used 
to bootstrap powerful vision models out of very little data. That’s what we will do in the next section.</p>

<p>For now, let’s get started by getting our hands on the data.</p>

<h2 id="downloading-the-data">Downloading the data</h2>

<p>The cats vs. dogs dataset that we will use isn’t packaged with Keras. It was made available by Kaggle.com as part of a computer vision 
competition in late 2013, back when convnets weren’t quite mainstream. You can download the original dataset at: 
<code class="highlighter-rouge">https://www.kaggle.com/c/dogs-vs-cats/data</code> (you will need to create a Kaggle account if you don’t already have one – don’t worry, the 
process is painless).</p>

<p>The pictures are medium-resolution color JPEGs. They look like this:</p>

<p><img src="https://s3.amazonaws.com/book.keras.io/img/ch5/cats_vs_dogs_samples.jpg" alt="cats_vs_dogs_samples" /></p>

<p>Unsurprisingly, the cats vs. dogs Kaggle competition in 2013 was won by entrants who used convnets. The best entries could achieve up to 
95% accuracy. In our own example, we will get fairly close to this accuracy (in the next section), even though we will be training our 
models on less than 10% of the data that was available to the competitors.
This original dataset contains 25,000 images of dogs and cats (12,500 from each class) and is 543MB large (compressed). After downloading 
and uncompressing it, we will create a new dataset containing three subsets: a training set with 1000 samples of each class, a validation 
set with 500 samples of each class, and finally a test set with 500 samples of each class.</p>

<p>Here are a few lines of code to do this:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">shutil</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'/home/jupyter-loecher'
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## DO NOT EXECUTE !!
</span>
<span class="c1"># The path to the directory where the original
# dataset was uncompressed
</span><span class="n">original_dataset_dir</span> <span class="o">=</span> <span class="s">'/home/loecher/data/train/'</span>

<span class="c1"># The directory where we will
# store our smaller dataset
</span><span class="n">base_dir</span> <span class="o">=</span> <span class="s">'/home/loecher/data/cats_and_dogs'</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>

<span class="c1"># Directories for our training,
# validation and test splits
</span><span class="n">train_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'train'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">train_dir</span><span class="p">)</span>
<span class="n">validation_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'validation'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">validation_dir</span><span class="p">)</span>
<span class="n">test_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'test'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">test_dir</span><span class="p">)</span>

<span class="c1"># Directory with our training cat pictures
</span><span class="n">train_cats_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="s">'cats'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">train_cats_dir</span><span class="p">)</span>

<span class="c1"># Directory with our training dog pictures
</span><span class="n">train_dogs_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="s">'dogs'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">train_dogs_dir</span><span class="p">)</span>

<span class="c1"># Directory with our validation cat pictures
</span><span class="n">validation_cats_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">validation_dir</span><span class="p">,</span> <span class="s">'cats'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">validation_cats_dir</span><span class="p">)</span>

<span class="c1"># Directory with our validation dog pictures
</span><span class="n">validation_dogs_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">validation_dir</span><span class="p">,</span> <span class="s">'dogs'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">validation_dogs_dir</span><span class="p">)</span>

<span class="c1"># Directory with our validation cat pictures
</span><span class="n">test_cats_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s">'cats'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">test_cats_dir</span><span class="p">)</span>

<span class="c1"># Directory with our validation dog pictures
</span><span class="n">test_dogs_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dir</span><span class="p">,</span> <span class="s">'dogs'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">test_dogs_dir</span><span class="p">)</span>

<span class="c1"># Copy first 1000 cat images to train_cats_dir
</span><span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s">'cat.{}.jpg'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_dataset_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_cats_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

<span class="c1"># Copy next 500 cat images to validation_cats_dir
</span><span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s">'cat.{}.jpg'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_dataset_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">validation_cats_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    
<span class="c1"># Copy next 500 cat images to test_cats_dir
</span><span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s">'cat.{}.jpg'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_dataset_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_cats_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    
<span class="c1"># Copy first 1000 dog images to train_dogs_dir
</span><span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s">'dog.{}.jpg'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_dataset_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dogs_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    
<span class="c1"># Copy next 500 dog images to validation_dogs_dir
</span><span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s">'dog.{}.jpg'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1500</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_dataset_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">validation_dogs_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    
<span class="c1"># Copy next 500 dog images to test_dogs_dir
</span><span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s">'dog.{}.jpg'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_dataset_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dogs_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
</code></pre></div></div>

<p>From 
https://colab.research.google.com/github/google/eng-edu/blob/master/ml/pc/exercises/image_classification_part1.ipynb</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!wget --no-check-certificate \
#    https://storage.googleapis.com/mledu-datasets/cats_and_dogs_filtered.zip \
#    -O /tmp/cats_and_dogs_filtered.zip
</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="n">local_zip</span> <span class="o">=</span> <span class="s">'/tmp/cats_and_dogs_filtered.zip'</span>
<span class="n">zip_ref</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">local_zip</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
<span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s">'/tmp'</span><span class="p">)</span>
<span class="n">zip_ref</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">base_dir</span> <span class="o">=</span> <span class="s">'/tmp/cats_and_dogs_filtered'</span>
<span class="n">train_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'train'</span><span class="p">)</span>
<span class="n">validation_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'validation'</span><span class="p">)</span>

<span class="c1"># Directory with our training cat pictures
</span><span class="n">train_cats_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="s">'cats'</span><span class="p">)</span>

<span class="c1"># Directory with our training dog pictures
</span><span class="n">train_dogs_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_dir</span><span class="p">,</span> <span class="s">'dogs'</span><span class="p">)</span>

<span class="c1"># Directory with our validation cat pictures
</span><span class="n">validation_cats_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">validation_dir</span><span class="p">,</span> <span class="s">'cats'</span><span class="p">)</span>

<span class="c1"># Directory with our validation dog pictures
</span><span class="n">validation_dogs_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">validation_dir</span><span class="p">,</span> <span class="s">'dogs'</span><span class="p">)</span>
</code></pre></div></div>

<p>Now, let’s see what the filenames look like in the cats and dogs train directories (file naming conventions are the same in the validation directory):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_cat_fnames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_cats_dir</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">train_cat_fnames</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>

<span class="n">train_dog_fnames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_dogs_dir</span><span class="p">)</span>
<span class="n">train_dog_fnames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="k">print</span> <span class="p">(</span><span class="n">train_dog_fnames</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
</code></pre></div></div>

<p>As a sanity check, let’s count how many pictures we have in each training split (train/validation/test):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">'total training cat images:'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_cats_dir</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total training cat images: 1000
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">'total training dog images:'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_dogs_dir</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total training dog images: 1000
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">'total validation cat images:'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">validation_cats_dir</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total validation cat images: 500
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">'total validation dog images:'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">validation_dogs_dir</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total validation dog images: 500
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">'total test cat images:'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">test_cats_dir</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total test cat images: 500
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">'total test dog images:'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">test_dogs_dir</span><span class="p">)))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total test dog images: 500
</code></pre></div></div>

<p>So we have indeed 2000 training images, and then 1000 validation images and 1000 test images. In each split, there is the same number of 
samples from each class: this is a balanced binary classification problem, which means that classification accuracy will be an appropriate 
measure of success.</p>

<h2 id="building-our-network">Building our network</h2>

<p>We’ve already built a small convnet for MNIST in the previous example, so you should be familiar with them. We will reuse the same 
general structure: our convnet will be a stack of alternated <code class="highlighter-rouge">Conv2D</code> (with <code class="highlighter-rouge">relu</code> activation) and <code class="highlighter-rouge">MaxPooling2D</code> layers.</p>

<p>However, since we are dealing with bigger images and a more complex problem, we will make our network accordingly larger: it will have one 
more <code class="highlighter-rouge">Conv2D</code> + <code class="highlighter-rouge">MaxPooling2D</code> stage. This serves both to augment the capacity of the network, and to further reduce the size of the 
feature maps, so that they aren’t overly large when we reach the <code class="highlighter-rouge">Flatten</code> layer. Here, since we start from inputs of size 150x150 (a 
somewhat arbitrary choice), we end up with feature maps of size 7x7 right before the <code class="highlighter-rouge">Flatten</code> layer.</p>

<p>Note that the depth of the feature maps is progressively increasing in the network (from 32 to 128), while the size of the feature maps is 
decreasing (from 148x148 to 7x7). This is a pattern that you will see in almost all convnets.</p>

<p>Since we are attacking a binary classification problem, we are ending the network with a single unit (a <code class="highlighter-rouge">Dense</code> layer of size 1) and a 
<code class="highlighter-rouge">sigmoid</code> activation. This unit will encode the probability that the network is looking at one class or the other.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">models</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span>
                        <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">))</span>
</code></pre></div></div>

<p>Let’s take a look at how the dimensions of the feature maps change with every successive layer:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

&lt;ipython-input-1-5f15418b3570&gt; in &lt;module&gt;
----&gt; 1 model.summary()


NameError: name 'model' is not defined
</code></pre></div></div>

<p>For our compilation step, we’ll go with the <code class="highlighter-rouge">RMSprop</code> optimizer as usual. Since we ended our network with a single sigmoid unit, we will 
use binary crossentropy as our loss (as a reminder, check out the table in Chapter 4, section 5 for a cheatsheet on what loss function to 
use in various situations).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">optimizers</span>

<span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizers</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'acc'</span><span class="p">])</span>
</code></pre></div></div>

<h2 id="data-preprocessing">Data preprocessing</h2>

<p>As you already know by now, data should be formatted into appropriately pre-processed floating point tensors before being fed into our 
network. Currently, our data sits on a drive as JPEG files, so the steps for getting it into our network are roughly:</p>

<ul>
  <li>Read the picture files.</li>
  <li>Decode the JPEG content to RBG grids of pixels.</li>
  <li>Convert these into floating point tensors.</li>
  <li>Rescale the pixel values (between 0 and 255) to the [0, 1] interval (as you know, neural networks prefer to deal with small input values).</li>
</ul>

<p>It may seem a bit daunting, but thankfully Keras has utilities to take care of these steps automatically. Keras has a module with image 
processing helper tools, located at <code class="highlighter-rouge">keras.preprocessing.image</code>. In particular, it contains the class <code class="highlighter-rouge">ImageDataGenerator</code> which allows to 
quickly set up Python generators that can automatically turn image files on disk into batches of pre-processed tensors. This is what we 
will use here.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>

<span class="c1"># All images will be rescaled by 1./255
</span><span class="n">train_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>
<span class="n">test_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>

<span class="n">train_generator</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span>
        <span class="c1"># This is the target directory
</span>        <span class="n">train_dir</span><span class="p">,</span>
        <span class="c1"># All images will be resized to 150x150
</span>        <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="c1"># Since we use binary_crossentropy loss, we need binary labels
</span>        <span class="n">class_mode</span><span class="o">=</span><span class="s">'binary'</span><span class="p">)</span>

<span class="n">validation_generator</span> <span class="o">=</span> <span class="n">test_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span>
        <span class="n">validation_dir</span><span class="p">,</span>
        <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">class_mode</span><span class="o">=</span><span class="s">'binary'</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

&lt;ipython-input-16-3f364d5f4e9d&gt; in &lt;module&gt;
      7 train_generator = train_datagen.flow_from_directory(
      8         # This is the target directory
----&gt; 9         train_dir,
     10         # All images will be resized to 150x150
     11         target_size=(150, 150),


NameError: name 'train_dir' is not defined
</code></pre></div></div>

<p>Let’s take a look at the output of one of these generators: it yields batches of 150x150 RGB images (shape <code class="highlighter-rouge">(20, 150, 150, 3)</code>) and binary 
labels (shape <code class="highlighter-rouge">(20,)</code>). 20 is the number of samples in each batch (the batch size). Note that the generator yields these batches 
indefinitely: it just loops endlessly over the images present in the target folder. For this reason, we need to <code class="highlighter-rouge">break</code> the iteration loop 
at some point.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">data_batch</span><span class="p">,</span> <span class="n">labels_batch</span> <span class="ow">in</span> <span class="n">train_generator</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'data batch shape:'</span><span class="p">,</span> <span class="n">data_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'labels batch shape:'</span><span class="p">,</span> <span class="n">labels_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">break</span>
</code></pre></div></div>

<p>Let’s fit our model to the data using the generator. We do it using the <code class="highlighter-rouge">fit_generator</code> method, the equivalent of <code class="highlighter-rouge">fit</code> for data generators 
like ours. It expects as first argument a Python generator that will yield batches of inputs and targets indefinitely, like ours does. 
Because the data is being generated endlessly, the generator needs to know example how many samples to draw from the generator before 
declaring an epoch over. This is the role of the <code class="highlighter-rouge">steps_per_epoch</code> argument: after having drawn <code class="highlighter-rouge">steps_per_epoch</code> batches from the 
generator, i.e. after having run for <code class="highlighter-rouge">steps_per_epoch</code> gradient descent steps, the fitting process will go to the next epoch. In our case, 
batches are 20-sample large, so it will take 100 batches until we see our target of 2000 samples.</p>

<p>When using <code class="highlighter-rouge">fit_generator</code>, one may pass a <code class="highlighter-rouge">validation_data</code> argument, much like with the <code class="highlighter-rouge">fit</code> method. Importantly, this argument is 
allowed to be a data generator itself, but it could be a tuple of Numpy arrays as well. If you pass a generator as <code class="highlighter-rouge">validation_data</code>, then 
this generator is expected to yield batches of validation data endlessly, and thus you should also specify the <code class="highlighter-rouge">validation_steps</code> argument, 
which tells the process how many batches to draw from the validation generator for evaluation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_generator</span><span class="p">(</span>
      <span class="n">train_generator</span><span class="p">,</span>
      <span class="n">steps_per_epoch</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
      <span class="n">epochs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
      <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_generator</span><span class="p">,</span>
      <span class="n">validation_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</code></pre></div></div>

<p>It is good practice to always save your models after training:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">'cats_and_dogs_small_1.h5'</span><span class="p">)</span>
</code></pre></div></div>

<p>Let’s plot the loss and accuracy of the model over the training and validation data during training:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">acc</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'acc'</span><span class="p">]</span>
<span class="n">val_acc</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_acc'</span><span class="p">]</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'loss'</span><span class="p">]</span>
<span class="n">val_loss</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_loss'</span><span class="p">]</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="s">'bo'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Training acc'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">val_acc</span><span class="p">,</span> <span class="s">'b'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Validation acc'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Training and validation accuracy'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="s">'bo'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Training loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">val_loss</span><span class="p">,</span> <span class="s">'b'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Validation loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Training and validation loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p>These plots are characteristic of overfitting. Our training accuracy increases linearly over time, until it reaches nearly 100%, while our 
validation accuracy stalls at 70-72%. Our validation loss reaches its minimum after only five epochs then stalls, while the training loss 
keeps decreasing linearly until it reaches nearly 0.</p>

<p>Because we only have relatively few training samples (2000), overfitting is going to be our number one concern. You already know about a 
number of techniques that can help mitigate overfitting, such as dropout and weight decay (L2 regularization). We are now going to 
introduce a new one, specific to computer vision, and used almost universally when processing images with deep learning models: <em>data 
augmentation</em>.</p>

<h2 id="using-data-augmentation">Using data augmentation</h2>

<p>Overfitting is caused by having too few samples to learn from, rendering us unable to train a model able to generalize to new data. 
Given infinite data, our model would be exposed to every possible aspect of the data distribution at hand: we would never overfit. Data 
augmentation takes the approach of generating more training data from existing training samples, by “augmenting” the samples via a number 
of random transformations that yield believable-looking images. The goal is that at training time, our model would never see the exact same 
picture twice. This helps the model get exposed to more aspects of the data and generalize better.</p>

<p>In Keras, this can be done by configuring a number of random transformations to be performed on the images read by our <code class="highlighter-rouge">ImageDataGenerator</code> 
instance. Let’s get started with an example:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span>
      <span class="n">rotation_range</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
      <span class="n">width_shift_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
      <span class="n">height_shift_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
      <span class="n">shear_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
      <span class="n">zoom_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
      <span class="n">horizontal_flip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
      <span class="n">fill_mode</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>
</code></pre></div></div>

<p>These are just a few of the options available (for more, see the Keras documentation). Let’s quickly go over what we just wrote:</p>

<ul>
  <li><code class="highlighter-rouge">rotation_range</code> is a value in degrees (0-180), a range within which to randomly rotate pictures.</li>
  <li><code class="highlighter-rouge">width_shift</code> and <code class="highlighter-rouge">height_shift</code> are ranges (as a fraction of total width or height) within which to randomly translate pictures 
vertically or horizontally.</li>
  <li><code class="highlighter-rouge">shear_range</code> is for randomly applying shearing transformations.</li>
  <li><code class="highlighter-rouge">zoom_range</code> is for randomly zooming inside pictures.</li>
  <li><code class="highlighter-rouge">horizontal_flip</code> is for randomly flipping half of the images horizontally – relevant when there are no assumptions of horizontal 
asymmetry (e.g. real-world pictures).</li>
  <li><code class="highlighter-rouge">fill_mode</code> is the strategy used for filling in newly created pixels, which can appear after a rotation or a width/height shift.</li>
</ul>

<p>Let’s take a look at our augmented images:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_cats_dir</span> <span class="o">=</span> <span class="s">'/home/loecher/data/cats_and_dogs/train/cats'</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># This is module with image preprocessing utilities
</span><span class="kn">from</span> <span class="nn">keras.preprocessing</span> <span class="kn">import</span> <span class="n">image</span>

<span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_cats_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">train_cats_dir</span><span class="p">)]</span>

<span class="c1"># We pick one image to "augment"
</span><span class="n">img_path</span> <span class="o">=</span> <span class="n">fnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># Read the image and resize it
</span><span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">load_img</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>

<span class="c1"># Convert it to a Numpy array with shape (150, 150, 3)
</span><span class="n">x</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="c1"># Reshape it to (1, 150, 150, 3)
</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># The .flow() command below generates batches of randomly transformed images.
# It will loop indefinitely, so we need to `break` the loop at some point!
</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">datagen</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">imgplot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">array_to_img</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1">#some_batches.append(batch[0])
</span>    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Number of pictures printed
</span>        <span class="k">break</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="output_41_0.png" alt="png" /></p>

<p><img src="output_41_1.png" alt="png" /></p>

<p><img src="output_41_2.png" alt="png" /></p>

<p><img src="output_41_3.png" alt="png" /></p>

<p>If we train a new network using this data augmentation configuration, our network will never see twice the same input. However, the inputs 
that it sees are still heavily intercorrelated, since they come from a small number of original images – we cannot produce new information, 
we can only remix existing information. As such, this might not be quite enough to completely get rid of overfitting. To further fight 
overfitting, we will also add a Dropout layer to our model, right before the densely-connected classifier:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span>
                        <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span> <span class="c1"># NOTE: 32 was changed to 64 to run the 5.4.2 code (due to 8x8)
</span><span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizers</span><span class="o">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'acc'</span><span class="p">])</span>
</code></pre></div></div>

<p>Let’s train our network using data augmentation and dropout:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">train_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span>
    <span class="n">rescale</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span>
    <span class="n">rotation_range</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">width_shift_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">height_shift_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">shear_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">zoom_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">horizontal_flip</span><span class="o">=</span><span class="bp">True</span><span class="p">,)</span>

<span class="c1"># Note that the validation data should not be augmented!
</span><span class="n">test_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>

<span class="n">train_generator</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span>
        <span class="c1"># This is the target directory
</span>        <span class="n">train_dir</span><span class="p">,</span>
        <span class="c1"># All images will be resized to 150x150
</span>        <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="c1"># Since we use binary_crossentropy loss, we need binary labels
</span>        <span class="n">class_mode</span><span class="o">=</span><span class="s">'binary'</span><span class="p">)</span>

<span class="n">validation_generator</span> <span class="o">=</span> <span class="n">test_datagen</span><span class="o">.</span><span class="n">flow_from_directory</span><span class="p">(</span>
        <span class="n">validation_dir</span><span class="p">,</span>
        <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">class_mode</span><span class="o">=</span><span class="s">'binary'</span><span class="p">)</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_generator</span><span class="p">(</span>
      <span class="n">train_generator</span><span class="p">,</span>
      <span class="n">steps_per_epoch</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
      <span class="n">epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
      <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_generator</span><span class="p">,</span>
      <span class="n">validation_steps</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Found 2000 images belonging to 2 classes.
Found 1000 images belonging to 2 classes.
Epoch 1/100
100/100 [==============================] - 34s 340ms/step - loss: 0.6891 - acc: 0.5334 - val_loss: 0.6686 - val_acc: 0.5742
Epoch 2/100
100/100 [==============================] - 33s 334ms/step - loss: 0.6745 - acc: 0.5684 - val_loss: 0.6531 - val_acc: 0.6037
Epoch 3/100
100/100 [==============================] - 32s 323ms/step - loss: 0.6500 - acc: 0.6144 - val_loss: 0.6305 - val_acc: 0.6307
Epoch 4/100
100/100 [==============================] - 33s 328ms/step - loss: 0.6365 - acc: 0.6269 - val_loss: 0.6089 - val_acc: 0.6430
Epoch 5/100
100/100 [==============================] - 33s 328ms/step - loss: 0.6134 - acc: 0.6650 - val_loss: 0.5935 - val_acc: 0.6701
Epoch 6/100
100/100 [==============================] - 33s 329ms/step - loss: 0.6007 - acc: 0.6669 - val_loss: 0.6074 - val_acc: 0.6643
Epoch 7/100
100/100 [==============================] - 32s 323ms/step - loss: 0.5996 - acc: 0.6700 - val_loss: 0.5806 - val_acc: 0.6802
Epoch 8/100
100/100 [==============================] - 33s 330ms/step - loss: 0.5880 - acc: 0.6891 - val_loss: 0.5632 - val_acc: 0.7055
Epoch 9/100
100/100 [==============================] - 33s 328ms/step - loss: 0.5814 - acc: 0.6753 - val_loss: 0.6103 - val_acc: 0.6604
Epoch 10/100
100/100 [==============================] - 32s 324ms/step - loss: 0.5752 - acc: 0.6928 - val_loss: 0.5717 - val_acc: 0.6885
Epoch 11/100
100/100 [==============================] - 33s 325ms/step - loss: 0.5576 - acc: 0.7125 - val_loss: 0.5328 - val_acc: 0.7088
Epoch 12/100
100/100 [==============================] - 32s 323ms/step - loss: 0.5655 - acc: 0.7013 - val_loss: 0.5697 - val_acc: 0.7011
Epoch 13/100
100/100 [==============================] - 33s 332ms/step - loss: 0.5611 - acc: 0.7037 - val_loss: 0.5686 - val_acc: 0.7120
Epoch 14/100
100/100 [==============================] - 33s 327ms/step - loss: 0.5535 - acc: 0.7097 - val_loss: 0.5238 - val_acc: 0.7265
Epoch 15/100
100/100 [==============================] - 33s 334ms/step - loss: 0.5452 - acc: 0.7291 - val_loss: 0.5341 - val_acc: 0.7352
Epoch 16/100
100/100 [==============================] - 32s 325ms/step - loss: 0.5348 - acc: 0.7362 - val_loss: 0.5255 - val_acc: 0.7236
Epoch 17/100
100/100 [==============================] - 33s 325ms/step - loss: 0.5469 - acc: 0.7156 - val_loss: 0.5126 - val_acc: 0.7430
Epoch 18/100
100/100 [==============================] - 34s 337ms/step - loss: 0.5339 - acc: 0.7297 - val_loss: 0.5448 - val_acc: 0.7152
Epoch 19/100
100/100 [==============================] - 32s 324ms/step - loss: 0.5224 - acc: 0.7259 - val_loss: 0.5645 - val_acc: 0.7005
Epoch 20/100
100/100 [==============================] - 34s 342ms/step - loss: 0.5251 - acc: 0.7337 - val_loss: 0.5010 - val_acc: 0.7448
Epoch 21/100
100/100 [==============================] - 38s 381ms/step - loss: 0.5171 - acc: 0.7459 - val_loss: 0.4821 - val_acc: 0.7557
Epoch 22/100
100/100 [==============================] - 37s 367ms/step - loss: 0.5159 - acc: 0.7484 - val_loss: 0.5188 - val_acc: 0.7474
Epoch 23/100
100/100 [==============================] - 33s 327ms/step - loss: 0.5116 - acc: 0.7456 - val_loss: 0.5118 - val_acc: 0.7360
Epoch 24/100
100/100 [==============================] - 33s 331ms/step - loss: 0.5038 - acc: 0.7544 - val_loss: 0.4689 - val_acc: 0.7713
Epoch 25/100
100/100 [==============================] - 33s 327ms/step - loss: 0.4966 - acc: 0.7528 - val_loss: 0.5264 - val_acc: 0.7371
Epoch 26/100
100/100 [==============================] - 32s 324ms/step - loss: 0.5050 - acc: 0.7431 - val_loss: 0.5111 - val_acc: 0.7481
Epoch 27/100
100/100 [==============================] - 33s 334ms/step - loss: 0.5024 - acc: 0.7500 - val_loss: 0.6032 - val_acc: 0.6901
Epoch 28/100
100/100 [==============================] - 34s 343ms/step - loss: 0.5012 - acc: 0.7463 - val_loss: 0.5170 - val_acc: 0.7525
Epoch 29/100
100/100 [==============================] - 47s 466ms/step - loss: 0.4931 - acc: 0.7616 - val_loss: 0.5437 - val_acc: 0.7390
Epoch 30/100
100/100 [==============================] - 41s 414ms/step - loss: 0.4948 - acc: 0.7538 - val_loss: 0.4769 - val_acc: 0.7773
Epoch 31/100
100/100 [==============================] - 33s 328ms/step - loss: 0.4832 - acc: 0.7634 - val_loss: 0.5248 - val_acc: 0.7397
Epoch 32/100
100/100 [==============================] - 32s 325ms/step - loss: 0.4895 - acc: 0.7612 - val_loss: 0.4857 - val_acc: 0.7661
Epoch 33/100
100/100 [==============================] - 32s 322ms/step - loss: 0.4746 - acc: 0.7719 - val_loss: 0.4984 - val_acc: 0.7633
Epoch 34/100
100/100 [==============================] - 33s 331ms/step - loss: 0.4820 - acc: 0.7572 - val_loss: 0.4754 - val_acc: 0.7577
Epoch 35/100
100/100 [==============================] - 32s 323ms/step - loss: 0.4766 - acc: 0.7734 - val_loss: 0.4488 - val_acc: 0.7843
Epoch 36/100
100/100 [==============================] - 33s 328ms/step - loss: 0.4673 - acc: 0.7709 - val_loss: 0.5524 - val_acc: 0.7365
Epoch 37/100
100/100 [==============================] - 32s 323ms/step - loss: 0.4664 - acc: 0.7728 - val_loss: 0.5555 - val_acc: 0.7367
Epoch 38/100
100/100 [==============================] - 33s 331ms/step - loss: 0.4708 - acc: 0.7731 - val_loss: 0.4921 - val_acc: 0.7519
Epoch 39/100
100/100 [==============================] - 32s 324ms/step - loss: 0.4574 - acc: 0.7844 - val_loss: 0.4485 - val_acc: 0.7811
Epoch 40/100
100/100 [==============================] - 33s 332ms/step - loss: 0.4603 - acc: 0.7841 - val_loss: 0.4790 - val_acc: 0.7706
Epoch 41/100
100/100 [==============================] - 33s 329ms/step - loss: 0.4708 - acc: 0.7866 - val_loss: 0.4591 - val_acc: 0.7867
Epoch 42/100
100/100 [==============================] - 33s 326ms/step - loss: 0.4608 - acc: 0.7819 - val_loss: 0.4237 - val_acc: 0.8020
Epoch 43/100
100/100 [==============================] - 33s 330ms/step - loss: 0.4451 - acc: 0.7940 - val_loss: 0.4649 - val_acc: 0.7719
Epoch 44/100
100/100 [==============================] - 33s 327ms/step - loss: 0.4483 - acc: 0.7850 - val_loss: 0.4626 - val_acc: 0.7728
Epoch 45/100
100/100 [==============================] - 33s 329ms/step - loss: 0.4415 - acc: 0.7912 - val_loss: 0.4742 - val_acc: 0.7674
Epoch 46/100
100/100 [==============================] - 33s 327ms/step - loss: 0.4508 - acc: 0.7863 - val_loss: 0.4311 - val_acc: 0.7862
Epoch 47/100
100/100 [==============================] - 33s 329ms/step - loss: 0.4365 - acc: 0.7866 - val_loss: 0.4551 - val_acc: 0.7861
Epoch 48/100
100/100 [==============================] - 33s 327ms/step - loss: 0.4433 - acc: 0.7912 - val_loss: 0.4693 - val_acc: 0.7784
Epoch 49/100
100/100 [==============================] - 32s 325ms/step - loss: 0.4396 - acc: 0.7913 - val_loss: 0.4819 - val_acc: 0.7659
Epoch 50/100
100/100 [==============================] - 33s 327ms/step - loss: 0.4346 - acc: 0.7962 - val_loss: 0.5620 - val_acc: 0.7603
Epoch 51/100
100/100 [==============================] - 32s 323ms/step - loss: 0.4332 - acc: 0.7981 - val_loss: 0.4355 - val_acc: 0.7944
Epoch 52/100
100/100 [==============================] - 34s 339ms/step - loss: 0.4211 - acc: 0.8031 - val_loss: 0.4864 - val_acc: 0.7635
Epoch 53/100
100/100 [==============================] - 33s 326ms/step - loss: 0.4140 - acc: 0.8066 - val_loss: 0.4894 - val_acc: 0.7747
Epoch 54/100
100/100 [==============================] - 33s 328ms/step - loss: 0.4220 - acc: 0.8016 - val_loss: 0.4838 - val_acc: 0.7693
Epoch 55/100
100/100 [==============================] - 32s 325ms/step - loss: 0.4253 - acc: 0.8037 - val_loss: 0.4664 - val_acc: 0.7665
Epoch 56/100
100/100 [==============================] - 33s 333ms/step - loss: 0.4271 - acc: 0.8013 - val_loss: 0.4370 - val_acc: 0.8041
Epoch 57/100
100/100 [==============================] - 33s 328ms/step - loss: 0.4196 - acc: 0.8013 - val_loss: 0.4442 - val_acc: 0.7932
Epoch 58/100
100/100 [==============================] - 33s 327ms/step - loss: 0.4070 - acc: 0.8159 - val_loss: 0.4250 - val_acc: 0.8046
Epoch 59/100
100/100 [==============================] - 33s 332ms/step - loss: 0.4175 - acc: 0.8066 - val_loss: 0.4358 - val_acc: 0.7912
Epoch 60/100
100/100 [==============================] - 33s 325ms/step - loss: 0.4192 - acc: 0.8087 - val_loss: 0.4929 - val_acc: 0.7627
Epoch 61/100
100/100 [==============================] - 33s 328ms/step - loss: 0.4039 - acc: 0.8150 - val_loss: 0.4358 - val_acc: 0.7996
Epoch 62/100
100/100 [==============================] - 33s 326ms/step - loss: 0.4106 - acc: 0.8100 - val_loss: 0.4423 - val_acc: 0.7995
Epoch 63/100
100/100 [==============================] - 33s 334ms/step - loss: 0.4015 - acc: 0.8141 - val_loss: 0.4223 - val_acc: 0.8093
Epoch 64/100
100/100 [==============================] - 33s 328ms/step - loss: 0.4045 - acc: 0.8147 - val_loss: 0.4287 - val_acc: 0.8028
Epoch 65/100
100/100 [==============================] - 32s 323ms/step - loss: 0.3957 - acc: 0.8131 - val_loss: 0.4439 - val_acc: 0.8014
Epoch 66/100
100/100 [==============================] - 33s 330ms/step - loss: 0.4011 - acc: 0.8184 - val_loss: 0.5133 - val_acc: 0.7945
Epoch 67/100
100/100 [==============================] - 32s 320ms/step - loss: 0.3911 - acc: 0.8197 - val_loss: 0.4677 - val_acc: 0.7938
Epoch 68/100
100/100 [==============================] - 33s 331ms/step - loss: 0.3986 - acc: 0.8266 - val_loss: 0.4554 - val_acc: 0.8035
Epoch 69/100
100/100 [==============================] - 32s 323ms/step - loss: 0.3822 - acc: 0.8291 - val_loss: 0.4739 - val_acc: 0.7906
Epoch 70/100
100/100 [==============================] - 33s 329ms/step - loss: 0.3907 - acc: 0.8206 - val_loss: 0.4225 - val_acc: 0.8196
Epoch 71/100
100/100 [==============================] - 32s 324ms/step - loss: 0.3875 - acc: 0.8278 - val_loss: 0.4572 - val_acc: 0.8122
Epoch 72/100
100/100 [==============================] - 33s 331ms/step - loss: 0.3887 - acc: 0.8194 - val_loss: 0.4501 - val_acc: 0.7938
Epoch 73/100
100/100 [==============================] - 33s 326ms/step - loss: 0.3777 - acc: 0.8284 - val_loss: 0.5260 - val_acc: 0.7790
Epoch 74/100
100/100 [==============================] - 32s 325ms/step - loss: 0.3753 - acc: 0.8384 - val_loss: 0.4243 - val_acc: 0.8039
Epoch 75/100
100/100 [==============================] - 33s 326ms/step - loss: 0.3870 - acc: 0.8278 - val_loss: 0.4143 - val_acc: 0.8086
Epoch 76/100
100/100 [==============================] - 32s 324ms/step - loss: 0.3773 - acc: 0.8366 - val_loss: 0.4166 - val_acc: 0.8192
Epoch 77/100
100/100 [==============================] - 33s 327ms/step - loss: 0.3706 - acc: 0.8294 - val_loss: 0.4616 - val_acc: 0.8054
Epoch 78/100
100/100 [==============================] - 32s 324ms/step - loss: 0.3649 - acc: 0.8300 - val_loss: 0.4047 - val_acc: 0.8204
Epoch 79/100
100/100 [==============================] - 33s 331ms/step - loss: 0.3617 - acc: 0.8378 - val_loss: 0.4001 - val_acc: 0.8338
Epoch 80/100
100/100 [==============================] - 32s 324ms/step - loss: 0.3696 - acc: 0.8337 - val_loss: 0.4469 - val_acc: 0.7945
Epoch 81/100
100/100 [==============================] - 32s 321ms/step - loss: 0.3562 - acc: 0.8419 - val_loss: 0.4342 - val_acc: 0.8096
Epoch 82/100
100/100 [==============================] - 33s 328ms/step - loss: 0.3619 - acc: 0.8366 - val_loss: 0.4344 - val_acc: 0.8138
Epoch 83/100
100/100 [==============================] - 32s 323ms/step - loss: 0.3725 - acc: 0.8284 - val_loss: 0.5361 - val_acc: 0.7900
Epoch 84/100
100/100 [==============================] - 33s 329ms/step - loss: 0.3488 - acc: 0.8453 - val_loss: 0.4690 - val_acc: 0.7784
Epoch 85/100
100/100 [==============================] - 32s 325ms/step - loss: 0.3583 - acc: 0.8409 - val_loss: 0.4496 - val_acc: 0.7893
Epoch 86/100
100/100 [==============================] - 33s 330ms/step - loss: 0.3629 - acc: 0.8391 - val_loss: 0.3936 - val_acc: 0.8318
Epoch 87/100
100/100 [==============================] - 33s 329ms/step - loss: 0.3465 - acc: 0.8459 - val_loss: 0.4205 - val_acc: 0.8154
Epoch 88/100
100/100 [==============================] - 33s 333ms/step - loss: 0.3403 - acc: 0.8544 - val_loss: 0.5666 - val_acc: 0.7919
Epoch 89/100
100/100 [==============================] - 33s 331ms/step - loss: 0.3578 - acc: 0.8375 - val_loss: 0.3980 - val_acc: 0.8331
Epoch 90/100
100/100 [==============================] - 32s 322ms/step - loss: 0.3565 - acc: 0.8434 - val_loss: 0.4294 - val_acc: 0.8166
Epoch 91/100
100/100 [==============================] - 33s 327ms/step - loss: 0.3343 - acc: 0.8453 - val_loss: 0.4239 - val_acc: 0.8235
Epoch 92/100
100/100 [==============================] - 32s 325ms/step - loss: 0.3484 - acc: 0.8500 - val_loss: 0.5225 - val_acc: 0.7811
Epoch 93/100
100/100 [==============================] - 33s 326ms/step - loss: 0.3523 - acc: 0.8425 - val_loss: 0.4181 - val_acc: 0.8293
Epoch 94/100
100/100 [==============================] - 33s 330ms/step - loss: 0.3390 - acc: 0.8466 - val_loss: 0.5930 - val_acc: 0.7646
Epoch 95/100
100/100 [==============================] - 33s 327ms/step - loss: 0.3414 - acc: 0.8484 - val_loss: 0.4632 - val_acc: 0.7977
Epoch 96/100
100/100 [==============================] - 32s 324ms/step - loss: 0.3295 - acc: 0.8537 - val_loss: 0.4123 - val_acc: 0.8164
Epoch 97/100
100/100 [==============================] - 32s 324ms/step - loss: 0.3344 - acc: 0.8581 - val_loss: 0.3890 - val_acc: 0.8249
Epoch 98/100
100/100 [==============================] - 33s 328ms/step - loss: 0.3204 - acc: 0.8609 - val_loss: 0.4758 - val_acc: 0.8293
Epoch 99/100
100/100 [==============================] - 33s 326ms/step - loss: 0.3218 - acc: 0.8591 - val_loss: 0.5690 - val_acc: 0.7500
Epoch 100/100
100/100 [==============================] - 33s 330ms/step - loss: 0.3291 - acc: 0.8587 - val_loss: 0.3975 - val_acc: 0.8247
--- 3310.1647398471832 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Run time:"</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="mf">3165.070887565613</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s">"minutes."</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Run time: 52.75 minutes.
</code></pre></div></div>

<p>Let’s save our model – we will be using it in the section on convnet visualization.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">'cats_and_dogs_small_2_1stlayer64.h5'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!cp cats_and_dogs_small_2.h5 cats_and_dogs_small_2_1stlayer64.h5
</span></code></pre></div></div>

<hr />

<h2 id="visualization-part-from-542">Visualization part from 5.4.2:</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model: "sequential_9"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d_33 (Conv2D)           (None, 148, 148, 64)      1792      
_________________________________________________________________
max_pooling2d_33 (MaxPooling (None, 74, 74, 64)        0         
_________________________________________________________________
conv2d_34 (Conv2D)           (None, 72, 72, 64)        36928     
_________________________________________________________________
max_pooling2d_34 (MaxPooling (None, 36, 36, 64)        0         
_________________________________________________________________
conv2d_35 (Conv2D)           (None, 34, 34, 128)       73856     
_________________________________________________________________
max_pooling2d_35 (MaxPooling (None, 17, 17, 128)       0         
_________________________________________________________________
conv2d_36 (Conv2D)           (None, 15, 15, 128)       147584    
_________________________________________________________________
max_pooling2d_36 (MaxPooling (None, 7, 7, 128)         0         
_________________________________________________________________
flatten_9 (Flatten)          (None, 6272)              0         
_________________________________________________________________
dropout_7 (Dropout)          (None, 6272)              0         
_________________________________________________________________
dense_17 (Dense)             (None, 512)               3211776   
_________________________________________________________________
dense_18 (Dense)             (None, 1)                 513       
=================================================================
Total params: 3,472,449
Trainable params: 3,472,449
Non-trainable params: 0
_________________________________________________________________
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">deprocess_image</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># normalize tensor: center on 0., ensure std is 0.1
</span>    <span class="n">x</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">/=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">*=</span> <span class="mf">0.1</span>

    <span class="c1"># clip to [0, 1]
</span>    <span class="n">x</span> <span class="o">+=</span> <span class="mf">0.5</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># convert to RGB array
</span>    <span class="n">x</span> <span class="o">*=</span> <span class="mi">255</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">generate_pattern</span><span class="p">(</span><span class="n">layer_name</span><span class="p">,</span> <span class="n">filter_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="c1"># Build a loss function that maximizes the activation
</span>    <span class="c1"># of the nth filter of the layer considered.
</span>    <span class="n">layer_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">layer_output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">filter_index</span><span class="p">])</span>

    <span class="c1"># Compute the gradient of the input picture wrt this loss
</span>    <span class="n">grads</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">gradients</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="nb">input</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Normalization trick: we normalize the gradient
</span>    <span class="n">grads</span> <span class="o">/=</span> <span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">grads</span><span class="p">)))</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>

    <span class="c1"># This function returns the loss and grads given the input picture
</span>    <span class="n">iterate</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="nb">input</span><span class="p">],</span> <span class="p">[</span><span class="n">loss</span><span class="p">,</span> <span class="n">grads</span><span class="p">])</span>
    
    <span class="c1"># We start from a gray image with some noise
</span>    <span class="n">input_img_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="mf">128.</span>

    <span class="c1"># Run gradient ascent for 40 steps
</span>    <span class="n">step</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">40</span><span class="p">):</span>
        <span class="n">loss_value</span><span class="p">,</span> <span class="n">grads_value</span> <span class="o">=</span> <span class="n">iterate</span><span class="p">([</span><span class="n">input_img_data</span><span class="p">])</span>
        <span class="n">input_img_data</span> <span class="o">+=</span> <span class="n">grads_value</span> <span class="o">*</span> <span class="n">step</span>
        
    <span class="n">img</span> <span class="o">=</span> <span class="n">input_img_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">deprocess_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">generate_pattern</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">127</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="output_57_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">layer_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">layer_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">layer_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">layer_sizes</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[64, 64, 64, 64, 128, 128, 128, 128, 6272, 6272, 512, 1]
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># This a empty (black) image where we will store our results.
</span>
<span class="c1"># results = np.zeros((8 * size + 7 * margin, 8 * size + 7 * margin, 3)) 
# First input corresponds to the first loop and defines the length of the plot
# Second input corresponds to second loop and defines the width of the plot
# The order stays the same, when the length is cut
</span>
<span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]:</span> <span class="c1"># the indices of the layers that should be printed and saved!!
</span>    
    <span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_names</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">layer_sizes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">length</span> <span class="o">*</span> <span class="n">size</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">margin</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> 
    <span class="c1"># First input corresponds to the first loop and defines the length of the plot
</span>    <span class="c1"># Second input corresponds to second loop and defines the width of the plot
</span>    <span class="c1"># The order stays the same, when the length is cut
</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>  <span class="c1"># iterate over the rows of our results grid
</span>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>  <span class="c1"># iterate over the columns of our results grid
</span>            <span class="c1"># Generate the pattern for filter `i + (j * 8)` in `layer_name`
</span>            <span class="n">filter_img</span> <span class="o">=</span> <span class="n">generate_pattern</span><span class="p">(</span><span class="n">layer_name</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
            <span class="c1">#print(i)
</span>            <span class="c1">#print(j)
</span>            <span class="c1">#print("__")
</span>            <span class="c1"># Put the result in the square `(i, j)` of the results grid
</span>            <span class="n">horizontal_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">size</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">margin</span>
            <span class="n">horizontal_end</span> <span class="o">=</span> <span class="n">horizontal_start</span> <span class="o">+</span> <span class="n">size</span>
            <span class="n">vertical_start</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="n">size</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">margin</span>
            <span class="n">vertical_end</span> <span class="o">=</span> <span class="n">vertical_start</span> <span class="o">+</span> <span class="n">size</span>
            <span class="n">results</span><span class="p">[</span><span class="n">horizontal_start</span> <span class="p">:</span> <span class="n">horizontal_end</span><span class="p">,</span> <span class="n">vertical_start</span> <span class="p">:</span> <span class="n">vertical_end</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">filter_img</span>

    <span class="c1"># Display the results grid
</span>    <span class="n">multiplier</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="mi">64</span><span class="p">)</span> <span class="c1"># using the multiplier makes sure that the plot is shown optimally 
</span>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">multiplier</span><span class="o">*</span><span class="mi">20</span><span class="p">))</span> <span class="c1"># (width, height)
</span>    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">layer_name</span> <span class="o">+</span> <span class="s">'_visualization.pdf'</span><span class="p">);</span> <span class="c1"># saves the figure
</span>    
<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="output_61_0.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Figure size 432x288 with 0 Axes&gt;
</code></pre></div></div>

<p><img src="output_61_2.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Figure size 432x288 with 0 Axes&gt;
</code></pre></div></div>

<p><img src="output_61_4.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Figure size 432x288 with 0 Axes&gt;
</code></pre></div></div>

<p><img src="output_61_6.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Figure size 432x288 with 0 Axes&gt;
</code></pre></div></div>

<p><img src="output_61_8.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Figure size 432x288 with 0 Axes&gt;
</code></pre></div></div>

<p><img src="output_61_10.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Figure size 432x288 with 0 Axes&gt;
</code></pre></div></div>

<p><img src="output_61_12.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Figure size 432x288 with 0 Axes&gt;
</code></pre></div></div>

<p><img src="output_61_14.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- 6278.773175239563 seconds ---



&lt;Figure size 432x288 with 0 Axes&gt;
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Plotting and saving the main 8 Layers from Model 2 took"</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="mf">6278.773175239563</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s">"minutes."</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Plotting and saving the main 8 Layers from Model 2 took 104.65 minutes.
</code></pre></div></div>

<h1 id="putting-all-functions-together">Putting all Functions together:</h1>

<p><strong>Generate Pattern, generate Train &amp; Valid Data, Predict (get Features), Flat Matrices, Accuracy, Feature Importance, Plots</strong></p>

<h2 id="running-on-small-neural-network">Running on small Neural Network</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s">'cats_and_dogs_small_2_1stlayer32.h5'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">models</span>

<span class="c1"># Extracts the outputs of the top 8 layers:
</span><span class="n">layer_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">output</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[:</span><span class="mi">12</span><span class="p">]]</span>
<span class="c1"># Creates a model that will return these outputs, given the model input:
</span><span class="n">activation_model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="nb">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">layer_outputs</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model: "sequential_6"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d_21 (Conv2D)           (None, 148, 148, 32)      896       
_________________________________________________________________
max_pooling2d_21 (MaxPooling (None, 74, 74, 32)        0         
_________________________________________________________________
conv2d_22 (Conv2D)           (None, 72, 72, 64)        18496     
_________________________________________________________________
max_pooling2d_22 (MaxPooling (None, 36, 36, 64)        0         
_________________________________________________________________
conv2d_23 (Conv2D)           (None, 34, 34, 128)       73856     
_________________________________________________________________
max_pooling2d_23 (MaxPooling (None, 17, 17, 128)       0         
_________________________________________________________________
conv2d_24 (Conv2D)           (None, 15, 15, 128)       147584    
_________________________________________________________________
max_pooling2d_24 (MaxPooling (None, 7, 7, 128)         0         
_________________________________________________________________
flatten_6 (Flatten)          (None, 6272)              0         
_________________________________________________________________
dropout_5 (Dropout)          (None, 6272)              0         
_________________________________________________________________
dense_11 (Dense)             (None, 512)               3211776   
_________________________________________________________________
dense_12 (Dense)             (None, 1)                 513       
=================================================================
Total params: 3,453,121
Trainable params: 3,453,121
Non-trainable params: 0
_________________________________________________________________
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">activation_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model: "model_1"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
conv2d_21_input (InputLayer) (None, 150, 150, 3)       0         
_________________________________________________________________
conv2d_21 (Conv2D)           (None, 148, 148, 32)      896       
_________________________________________________________________
max_pooling2d_21 (MaxPooling (None, 74, 74, 32)        0         
_________________________________________________________________
conv2d_22 (Conv2D)           (None, 72, 72, 64)        18496     
_________________________________________________________________
max_pooling2d_22 (MaxPooling (None, 36, 36, 64)        0         
_________________________________________________________________
conv2d_23 (Conv2D)           (None, 34, 34, 128)       73856     
_________________________________________________________________
max_pooling2d_23 (MaxPooling (None, 17, 17, 128)       0         
_________________________________________________________________
conv2d_24 (Conv2D)           (None, 15, 15, 128)       147584    
_________________________________________________________________
max_pooling2d_24 (MaxPooling (None, 7, 7, 128)         0         
_________________________________________________________________
flatten_6 (Flatten)          (None, 6272)              0         
_________________________________________________________________
dropout_5 (Dropout)          (None, 6272)              0         
_________________________________________________________________
dense_11 (Dense)             (None, 512)               3211776   
_________________________________________________________________
dense_12 (Dense)             (None, 1)                 513       
=================================================================
Total params: 3,453,121
Trainable params: 3,453,121
Non-trainable params: 0
_________________________________________________________________
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">activation_model</span><span class="o">.</span><span class="n">output_shape</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[(None, 148, 148, 32),
 (None, 74, 74, 32),
 (None, 72, 72, 64),
 (None, 36, 36, 64),
 (None, 34, 34, 128),
 (None, 17, 17, 128),
 (None, 15, 15, 128),
 (None, 7, 7, 128),
 (None, 6272),
 (None, 6272),
 (None, 512),
 (None, 1)]
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">mul</span>

<span class="kn">from</span> <span class="nn">keras.preprocessing</span> <span class="kn">import</span> <span class="n">image</span>
<span class="kn">from</span> <span class="nn">keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="n">lgb</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span>

<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">activation_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">layer_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">layer_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">activation_model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">layer_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Chollet Function 
</span>
<span class="k">def</span> <span class="nf">deprocess_image</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># normalize tensor: center on 0., ensure std is 0.1
</span>    <span class="n">x</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">/=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">*=</span> <span class="mf">0.1</span>

    <span class="c1"># clip to [0, 1]
</span>    <span class="n">x</span> <span class="o">+=</span> <span class="mf">0.5</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># convert to RGB array
</span>    <span class="n">x</span> <span class="o">*=</span> <span class="mi">255</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Chollet Function
</span>
<span class="k">def</span> <span class="nf">generate_pattern</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">layer_name</span><span class="p">,</span> <span class="n">filter_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span>
    <span class="c1"># Build a loss function that maximizes the activation
</span>    <span class="c1"># of the nth filter of the layer considered.
</span>    <span class="n">layer_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">layer_name</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">layer_output</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">filter_index</span><span class="p">])</span>

    <span class="c1"># Compute the gradient of the input picture wrt this loss
</span>    <span class="n">grads</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">gradients</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="nb">input</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Normalization trick: we normalize the gradient
</span>    <span class="n">grads</span> <span class="o">/=</span> <span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">grads</span><span class="p">)))</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>

    <span class="c1"># This function returns the loss and grads given the input picture
</span>    <span class="n">iterate</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">function</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="nb">input</span><span class="p">],</span> <span class="p">[</span><span class="n">loss</span><span class="p">,</span> <span class="n">grads</span><span class="p">])</span>
    
    <span class="c1"># We start from a gray image with some noise
</span>    <span class="n">input_img_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mi">20</span> <span class="o">+</span> <span class="mf">128.</span>

    <span class="c1"># Run gradient ascent for 40 steps
</span>    <span class="n">step</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">40</span><span class="p">):</span>
        <span class="n">loss_value</span><span class="p">,</span> <span class="n">grads_value</span> <span class="o">=</span> <span class="n">iterate</span><span class="p">([</span><span class="n">input_img_data</span><span class="p">])</span>
        <span class="n">input_img_data</span> <span class="o">+=</span> <span class="n">grads_value</span> <span class="o">*</span> <span class="n">step</span>
        
    <span class="n">img</span> <span class="o">=</span> <span class="n">input_img_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">deprocess_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Function No. 1
</span>
<span class="k">def</span> <span class="nf">gen_train_valid_data</span><span class="p">():</span>
    <span class="c1"># Training part 
</span>    <span class="kn">from</span> <span class="nn">keras.preprocessing</span> <span class="kn">import</span> <span class="n">image</span>
    
    <span class="n">datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span>
      <span class="n">rotation_range</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
      <span class="n">width_shift_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
      <span class="n">height_shift_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
      <span class="n">shear_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
      <span class="n">zoom_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
      <span class="n">horizontal_flip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
      <span class="n">fill_mode</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>
    
    <span class="n">all_augmented_pictures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'cat'</span><span class="p">,</span> <span class="s">'dog'</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span> <span class="c1"># number of cats pictures in the following folder
</span>            <span class="c1"># For Local Server 
</span>            <span class="c1">#img_path = '/Users/Nik/Documents/CodeAndStats/deep-learning-with-python-notebooks-master-2/train/' + animal +'s/' + animal + '.' + str(i) + '.jpg'
</span>            <span class="c1"># For Plato Server 
</span>            <span class="n">img_path</span> <span class="o">=</span> <span class="s">'/home/loecher/data/cats_and_dogs/train/'</span> <span class="o">+</span> <span class="n">animal</span> <span class="o">+</span><span class="s">'s/'</span> <span class="o">+</span> <span class="n">animal</span> <span class="o">+</span> <span class="s">'.'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.jpg'</span>
            
            <span class="c1"># Read the image and resize it
</span>            <span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">load_img</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>
            
            <span class="c1"># Convert it to a Numpy array with shape (150, 150, 3)
</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="c1"># Reshape it to (1, 150, 150, 3)
</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            
            <span class="c1"># The .flow() command below generates batches of randomly transformed images.
</span>            <span class="c1"># It will loop indefinitely, so we need to `break` the loop at some point!
</span>            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">datagen</span><span class="o">.</span><span class="n">flow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1">#plt.figure(i)
</span>                <span class="c1">#imgplot = plt.imshow(image.array_to_img(batch[0]))
</span>                <span class="c1">#all_augmented_pictures.append(batch[0]/255.) # NOTE: probably has to be resized
</span>                <span class="n">all_augmented_pictures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">array_to_img</span><span class="p">(</span><span class="n">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Number of pictures printed
</span>                    <span class="k">break</span>

    <span class="c1"># Validation part 
</span>    <span class="n">validation_pictures</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'cat'</span><span class="p">,</span> <span class="s">'dog'</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1500</span><span class="p">):</span> <span class="c1"># number of cats pictures in the following folder
</span>            <span class="c1"># For Local Server # 
</span>            <span class="c1">#img_path = '/Users/Nik/Documents/CodeAndStats/deep-learning-with-python-notebooks-master-2/validation/' + animal +'s/' + animal + '.' + str(i) + '.jpg'
</span>            <span class="c1"># For Plato Server 
</span>            <span class="n">img_path</span> <span class="o">=</span> <span class="s">'/home/loecher/data/cats_and_dogs/validation/'</span> <span class="o">+</span> <span class="n">animal</span> <span class="o">+</span><span class="s">'s/'</span> <span class="o">+</span> <span class="n">animal</span> <span class="o">+</span> <span class="s">'.'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.jpg'</span>
            <span class="c1"># This is module with image preprocessing utilities
</span>            <span class="kn">from</span> <span class="nn">keras.preprocessing</span> <span class="kn">import</span> <span class="n">image</span>

            <span class="c1"># Read the image and resize it
</span>            <span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">load_img</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>

            <span class="c1"># Convert it to a Numpy array with shape (150, 150, 3)
</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

            <span class="c1"># Reshape it to (1, 150, 150, 3)
</span>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">x</span> <span class="o">/=</span> <span class="mf">255.</span>

            <span class="n">validation_pictures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            
    <span class="k">return</span><span class="p">(</span><span class="n">all_augmented_pictures</span><span class="p">,</span> <span class="n">validation_pictures</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Function No. 2
</span><span class="k">def</span> <span class="nf">flat_matrices</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">train_img</span><span class="p">,</span> <span class="n">validation_img</span><span class="p">):</span>
    
    <span class="c1"># size = functools.reduce(mul, layer_sizes[index])
</span>    <span class="c1">#training 
</span>    <span class="n">flattened_matrix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_img</span><span class="p">)):</span>
        <span class="n">predicts_train</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">train_img</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">predicts_train_shape</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">predicts_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">flattened_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predicts_train</span><span class="p">,</span> <span class="n">predicts_train_shape</span><span class="p">))</span>
    <span class="n">flattened_matrix_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">flattened_matrix</span><span class="p">)</span>

    <span class="c1">#validation
</span>    <span class="n">flattened_matrix_valid</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">validation_img</span><span class="p">)):</span>
        <span class="n">predicts_valid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">validation_img</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">predicts_valid_shape</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="nb">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">predicts_valid</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">flattened_matrix_valid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predicts_valid</span><span class="p">,</span> <span class="n">predicts_valid_shape</span><span class="p">))</span>
    <span class="n">flattened_matrix_valid_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">flattened_matrix_valid</span><span class="p">)</span>
    
    <span class="c1"># cats are 0 
</span>    <span class="c1"># dogs are 1
</span>    <span class="n">train_labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4000</span>
    
    <span class="c1"># cats are 0 
</span>    <span class="c1"># dogs are 1
</span>    <span class="n">validation_labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">500</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">500</span>
    
    <span class="n">layer_shape_output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span>
    
    <span class="k">print</span><span class="p">(</span><span class="s">"Layer name:"</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Output shape:"</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">output_shape</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">flattened_matrix_np</span><span class="p">,</span> <span class="n">flattened_matrix_valid_np</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">validation_labels</span><span class="p">,</span> <span class="n">layer_shape_output</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Function No. 3
</span><span class="k">def</span> <span class="nf">acc_and_features</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">validation</span><span class="p">,</span> <span class="n">validations_labels</span><span class="p">,</span> <span class="n">train_label</span><span class="p">,</span> <span class="n">layer_shapes</span><span class="p">,</span> <span class="n">l_rate</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
    
    <span class="n">d_train</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">train_label</span><span class="p">)</span>
    
    <span class="c1"># parameter 
</span>    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params</span><span class="p">[</span><span class="s">'learning_rate'</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_rate</span>
    <span class="n">params</span><span class="p">[</span><span class="s">'boosting_type'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'gbdt'</span>
    <span class="n">params</span><span class="p">[</span><span class="s">'objective'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'binary'</span>
    <span class="n">params</span><span class="p">[</span><span class="s">'metric'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'binary_logloss'</span>
    <span class="n">params</span><span class="p">[</span><span class="s">'sub_feature'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># keep at 1 for Boosting only
</span>    <span class="n">params</span><span class="p">[</span><span class="s">'num_leaves'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">params</span><span class="p">[</span><span class="s">'min_data'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">params</span><span class="p">[</span><span class="s">'max_depth'</span><span class="p">]</span> <span class="o">=</span> <span class="n">depth</span>
    <span class="c1">#params['max_bin'] = 10
</span>    <span class="n">params</span><span class="p">[</span><span class="s">'bagging_fraction'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.25</span>
    
    <span class="n">clf</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">d_train</span><span class="p">,</span> <span class="n">iterations</span><span class="p">)</span> <span class="c1"># trains
</span>    
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">validation</span><span class="p">)</span> <span class="c1"># predicts
</span>    
    <span class="n">top_n_features</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">(</span><span class="s">"gain"</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[</span><span class="o">-</span><span class="n">n_features</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># returns top n features positions
</span>    <span class="n">top_n_dimensions</span> <span class="o">=</span> <span class="n">top_n_features</span> <span class="o">%</span> <span class="n">layer_shapes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
    <span class="n">unique</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">top_n_dimensions</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">top_n_dimensions_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">'label'</span><span class="p">:</span> <span class="n">unique</span><span class="p">,</span> <span class="s">'Counts'</span><span class="p">:</span> <span class="n">counts</span><span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s">"Counts"</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
     
    <span class="k">print</span><span class="p">(</span><span class="s">"Training shape:"</span><span class="p">,</span> <span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"The accuracy is:"</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="n">y_pred</span><span class="p">),</span> <span class="n">validations_labels</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">top_n_features</span><span class="p">,</span> <span class="n">top_n_dimensions</span><span class="p">,</span> <span class="n">top_n_dimensions_df</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_dimensions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">top_dimensions</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="c1"># ax enables access to manipulate each of subplots
</span>    <span class="n">ax</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_dimensions</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
    <span class="c1"># for i in range(columns*rows):
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_dimensions</span><span class="p">)):</span>
        <span class="c1"># create subplot and append to ax
</span>        <span class="c1">#ax.append(fig.add_subplot(rows, columns, i+1))
</span>        <span class="n">ax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">"Dimension:"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">top_dimensions</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>  <span class="c1"># set title
</span>        <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">generate_pattern</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">top_dimensions</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="c1">#ax[2].plot(xs, 3*ys)
</span>    <span class="c1">#ax[19].plot(ys**2, xs)
</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># finally, render the plot
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">run_all</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">iteration</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">features</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
    <span class="n">all_augmented_pictures</span><span class="p">,</span> <span class="n">validation_pictures</span> <span class="o">=</span> <span class="n">gen_train_valid_data</span><span class="p">()</span>
    <span class="n">train_matrices</span><span class="p">,</span> <span class="n">validation_matrices</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">valid_labels</span><span class="p">,</span> <span class="n">layer_shape</span> <span class="o">=</span> <span class="n">flat_matrices</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">all_augmented_pictures</span><span class="p">,</span> <span class="n">validation_pictures</span><span class="p">)</span>
    <span class="n">top_features</span><span class="p">,</span> <span class="n">top_dimensions</span><span class="p">,</span> <span class="n">top_dim_counts</span> <span class="o">=</span> <span class="n">acc_and_features</span><span class="p">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">iteration</span><span class="p">,</span> 
                                                            <span class="n">train</span> <span class="o">=</span> <span class="n">train_matrices</span><span class="p">,</span> 
                                                            <span class="n">validation</span> <span class="o">=</span> <span class="n">validation_matrices</span><span class="p">,</span> 
                                                            <span class="n">validations_labels</span> <span class="o">=</span> <span class="n">valid_labels</span><span class="p">,</span>
                                                            <span class="n">train_label</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">,</span>
                                                            <span class="n">layer_shapes</span> <span class="o">=</span> <span class="n">layer_shape</span><span class="p">,</span>
                                                            <span class="n">depth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                                                            <span class="n">n_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">)</span>
    <span class="n">plot_dimensions</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">top_dimensions</span> <span class="o">=</span> <span class="n">top_dimensions</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">run_all</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer name: conv2d_21
Output shape: (None, 148, 148, 32)
Training shape: (8000, 175232)
The accuracy is: 0.682
</code></pre></div></div>

<p><img src="output_83_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">run_all</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer name: conv2d_23
Output shape: (None, 34, 34, 128)
Training shape: (8000, 36992)
The accuracy is: 0.762
</code></pre></div></div>

<p><img src="output_84_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">run_all</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer name: max_pooling2d_23
Output shape: (None, 17, 17, 128)
Training shape: (8000, 28800)
The accuracy is: 0.795
</code></pre></div></div>

<p><img src="output_85_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 0.823
</span><span class="n">run_all</span><span class="p">(</span><span class="n">activation_model</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer name: max_pooling2d_24
Output shape: (None, 7, 7, 128)
Training shape: (8000, 6272)
The accuracy is: 0.814
</code></pre></div></div>

<p><img src="output_86_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># NEW NEW NEW
# 0.823
</span><span class="n">run_all</span><span class="p">(</span><span class="n">activation_model</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer name: max_pooling2d_24
Output shape: (None, 7, 7, 128)
Training shape: (8000, 6272)
The accuracy is: 0.814
</code></pre></div></div>

<p><img src="output_87_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">all_augmented_pictures</span><span class="p">,</span> <span class="n">validation_pictures</span> <span class="o">=</span> <span class="n">gen_train_valid_data</span><span class="p">()</span>
<span class="n">train_matrices</span><span class="p">,</span> <span class="n">validation_matrices</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">valid_labels</span><span class="p">,</span> <span class="n">layer_shape</span> <span class="o">=</span> <span class="n">flat_matrices</span><span class="p">(</span><span class="n">activation_model_large</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">all_augmented_pictures</span><span class="p">,</span> <span class="n">validation_pictures</span><span class="p">)</span>
<span class="n">top_features</span><span class="p">,</span> <span class="n">top_dimensions</span><span class="p">,</span> <span class="n">top_dim_counts</span> <span class="o">=</span> <span class="n">acc_and_features</span><span class="p">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> 
                                                            <span class="n">train</span> <span class="o">=</span> <span class="n">train_matrices</span><span class="p">,</span> 
                                                            <span class="n">validation</span> <span class="o">=</span> <span class="n">validation_matrices</span><span class="p">,</span> 
                                                            <span class="n">validations_labels</span> <span class="o">=</span> <span class="n">valid_labels</span><span class="p">,</span>
                                                            <span class="n">train_label</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">,</span>
                                                            <span class="n">layer_shapes</span> <span class="o">=</span> <span class="n">layer_shape</span><span class="p">,</span>
                                                            <span class="n">depth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                                                            <span class="n">n_features</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">plot_dimensions</span><span class="p">(</span><span class="n">activation_model_large</span><span class="p">,</span> <span class="n">top_dimensions</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">11</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer name: block4_conv1
Output shape: (None, 18, 18, 512)
Training shape: (8000, 165888)
The accuracy is: 0.732
</code></pre></div></div>

<p><img src="output_89_1.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- 551.5714266300201 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<h2 id="call-python-function">Call Python Function</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">run</span> <span class="n">CNN</span><span class="o">-</span><span class="n">plot</span><span class="o">.</span><span class="n">py</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer name: block4_conv1
Output shape: (None, 18, 18, 512)
Training shape: (8000, 165888)
The accuracy is: 0.695
</code></pre></div></div>

<p><img src="output_92_1.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- 552.6282608509064 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<h3 id="layer-11-large-neural-network">Layer 11, Large Neural Network:</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">all_augmented_pictures</span><span class="p">,</span> <span class="n">validation_pictures</span> <span class="o">=</span> <span class="n">gen_train_valid_data</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- 42.851104497909546 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">train_matrices</span><span class="p">,</span> <span class="n">validation_matrices</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">valid_labels</span><span class="p">,</span> <span class="n">layer_shape</span> <span class="o">=</span> <span class="n">flat_matrices</span><span class="p">(</span><span class="n">activation_model_large</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">all_augmented_pictures</span><span class="p">,</span> <span class="n">validation_pictures</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer name: block4_conv1
Output shape: (None, 18, 18, 512)
--- 302.0625202655792 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">top_features</span><span class="p">,</span> <span class="n">top_dimensions</span><span class="p">,</span> <span class="n">top_dim_counts</span> <span class="o">=</span> <span class="n">acc_and_features</span><span class="p">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> 
                                                            <span class="n">train</span> <span class="o">=</span> <span class="n">train_matrices</span><span class="p">,</span> 
                                                            <span class="n">validation</span> <span class="o">=</span> <span class="n">validation_matrices</span><span class="p">,</span> 
                                                            <span class="n">validations_labels</span> <span class="o">=</span> <span class="n">valid_labels</span><span class="p">,</span>
                                                            <span class="n">train_label</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">,</span>
                                                            <span class="n">layer_shapes</span> <span class="o">=</span> <span class="n">layer_shape</span><span class="p">,</span>
                                                            <span class="n">depth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                                                            <span class="n">n_features</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Training shape: (8000, 165888)
The accuracy is: 0.865
--- 1041.1322185993195 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">top_dimensions</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([404, 319, 251, 404, 403, 167, 404, 436,  25, 403, 159, 205, 155,
       134, 356,  29, 251, 452,  72, 356, 297, 403, 165, 152, 167,  65,
        72, 356, 205, 347, 476,  17, 251, 375, 353, 109, 251, 216, 155,
       428, 134, 501,  17,  72, 404, 250, 356, 216, 134, 251, 347,  17,
        73, 303, 403,  92, 167, 140, 251, 404, 471, 155, 404, 404, 251,
       203,  14, 319, 134, 216, 134, 136, 403,  17, 316, 404, 423, 251,
       413, 155, 399, 167, 468, 356,  80, 356, 316, 356, 371, 216, 477,
       124, 503, 423, 347, 338, 347, 303,  22, 403])
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">generate_pattern</span><span class="p">(</span><span class="n">activation_model_large</span><span class="p">,</span> <span class="n">activation_model_large</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">top_dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"The max. Dimension for this Layer is:"</span><span class="p">,</span> <span class="n">layer_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"The name of the Layer is:"</span><span class="p">,</span> <span class="n">activation_model_large</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The max. Dimension for this Layer is: 512
The name of the Layer is: block4_conv1
</code></pre></div></div>

<p><img src="output_99_1.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- 2.999497175216675 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">plot_dimensions</span><span class="p">(</span><span class="n">activation_model_large</span><span class="p">,</span> <span class="n">top_dimensions</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">11</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="output_100_0.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- 311.4335241317749 seconds ---
</code></pre></div></div>

<h3 id="layer-1-large-neural-network">Layer 1, Large Neural Network:</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">all_augmented_pictures</span><span class="p">,</span> <span class="n">validation_pictures</span> <span class="o">=</span> <span class="n">gen_train_valid_data</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- 43.56447434425354 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">train_matrices</span><span class="p">,</span> <span class="n">validation_matrices</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">valid_labels</span><span class="p">,</span> <span class="n">layer_shape</span> <span class="o">=</span> <span class="n">flat_matrices</span><span class="p">(</span><span class="n">activation_model_large</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">all_augmented_pictures</span><span class="p">,</span> <span class="n">validation_pictures</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer name: block1_conv1
Output shape: (None, 150, 150, 64)
--- 323.7565836906433 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">layer_shape</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(None, 150, 150, 64)
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">top_features</span><span class="p">,</span> <span class="n">top_dimensions</span><span class="p">,</span> <span class="n">top_dim_counts</span> <span class="o">=</span> <span class="n">acc_and_features</span><span class="p">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> 
                                                            <span class="n">train</span> <span class="o">=</span> <span class="n">train_matrices</span><span class="p">,</span> 
                                                            <span class="n">validation</span> <span class="o">=</span> <span class="n">validation_matrices</span><span class="p">,</span> 
                                                            <span class="n">validations_labels</span> <span class="o">=</span> <span class="n">valid_labels</span><span class="p">,</span>
                                                            <span class="n">train_label</span> <span class="o">=</span> <span class="n">train_labels</span><span class="p">,</span>
                                                            <span class="n">layer_shapes</span> <span class="o">=</span> <span class="n">layer_shape</span><span class="p">,</span>
                                                            <span class="n">depth</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                                                            <span class="n">n_features</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">top_dimensions</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">generate_pattern</span><span class="p">(</span><span class="n">activation_model_large</span><span class="p">,</span> <span class="n">activation_model_large</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"The max. Dimension for this Layer is:"</span><span class="p">,</span> <span class="n">layer_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"The name of the Layer is:"</span><span class="p">,</span> <span class="n">activation_model_large</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The max. Dimension for this Layer is: 64
The name of the Layer is: block1_conv1
</code></pre></div></div>

<p><img src="output_107_1.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- 0.4292943477630615 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hundred_dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">plot_dimensions</span><span class="p">(</span><span class="n">activation_model_large</span><span class="p">,</span> <span class="n">hundred_dims</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<p><img src="output_109_0.png" alt="png" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- 36.11064791679382 seconds ---
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<h2 id="running-on-large-neural-network">Running on large Neural Network</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras.applications</span> <span class="kn">import</span> <span class="n">VGG16</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">model_large</span> <span class="o">=</span> <span class="n">VGG16</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s">'imagenet'</span><span class="p">,</span>
              <span class="n">include_top</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
             <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># layer_name = 'block3_conv1'
# filter_index = 0
</span>
<span class="c1"># layer_output = model.get_layer(layer_name).output
# loss = K.mean(layer_output[:, :, :, filter_index])
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model_large</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model: "vgg16"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         (None, 150, 150, 3)       0         
_________________________________________________________________
block1_conv1 (Conv2D)        (None, 150, 150, 64)      1792      
_________________________________________________________________
block1_conv2 (Conv2D)        (None, 150, 150, 64)      36928     
_________________________________________________________________
block1_pool (MaxPooling2D)   (None, 75, 75, 64)        0         
_________________________________________________________________
block2_conv1 (Conv2D)        (None, 75, 75, 128)       73856     
_________________________________________________________________
block2_conv2 (Conv2D)        (None, 75, 75, 128)       147584    
_________________________________________________________________
block2_pool (MaxPooling2D)   (None, 37, 37, 128)       0         
_________________________________________________________________
block3_conv1 (Conv2D)        (None, 37, 37, 256)       295168    
_________________________________________________________________
block3_conv2 (Conv2D)        (None, 37, 37, 256)       590080    
_________________________________________________________________
block3_conv3 (Conv2D)        (None, 37, 37, 256)       590080    
_________________________________________________________________
block3_pool (MaxPooling2D)   (None, 18, 18, 256)       0         
_________________________________________________________________
block4_conv1 (Conv2D)        (None, 18, 18, 512)       1180160   
_________________________________________________________________
block4_conv2 (Conv2D)        (None, 18, 18, 512)       2359808   
_________________________________________________________________
block4_conv3 (Conv2D)        (None, 18, 18, 512)       2359808   
_________________________________________________________________
block4_pool (MaxPooling2D)   (None, 9, 9, 512)         0         
_________________________________________________________________
block5_conv1 (Conv2D)        (None, 9, 9, 512)         2359808   
_________________________________________________________________
block5_conv2 (Conv2D)        (None, 9, 9, 512)         2359808   
_________________________________________________________________
block5_conv3 (Conv2D)        (None, 9, 9, 512)         2359808   
_________________________________________________________________
block5_pool (MaxPooling2D)   (None, 4, 4, 512)         0         
=================================================================
Total params: 14,714,688
Trainable params: 14,714,688
Non-trainable params: 0
_________________________________________________________________
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">models</span>

<span class="c1"># Extracts the outputs of the top 8 layers:
</span><span class="n">layer_outputs_large</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">output</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model_large</span><span class="o">.</span><span class="n">layers</span><span class="p">[:</span><span class="mi">16</span><span class="p">]]</span>
<span class="c1"># Creates a model that will return these outputs, given the model input:
</span><span class="n">activation_model_large</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">model_large</span><span class="o">.</span><span class="nb">input</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">layer_outputs_large</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="c1"># skip input layer
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">layer_sizes_large</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">activation_model_large</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">layer_sizes_large</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">output_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="n">layer_names_large</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">activation_model_large</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">layer_names_large</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">activation_model_large</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model: "model_2"
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         (None, 150, 150, 3)       0         
_________________________________________________________________
block1_conv1 (Conv2D)        (None, 150, 150, 64)      1792      
_________________________________________________________________
block1_conv2 (Conv2D)        (None, 150, 150, 64)      36928     
_________________________________________________________________
block1_pool (MaxPooling2D)   (None, 75, 75, 64)        0         
_________________________________________________________________
block2_conv1 (Conv2D)        (None, 75, 75, 128)       73856     
_________________________________________________________________
block2_conv2 (Conv2D)        (None, 75, 75, 128)       147584    
_________________________________________________________________
block2_pool (MaxPooling2D)   (None, 37, 37, 128)       0         
_________________________________________________________________
block3_conv1 (Conv2D)        (None, 37, 37, 256)       295168    
_________________________________________________________________
block3_conv2 (Conv2D)        (None, 37, 37, 256)       590080    
_________________________________________________________________
block3_conv3 (Conv2D)        (None, 37, 37, 256)       590080    
_________________________________________________________________
block3_pool (MaxPooling2D)   (None, 18, 18, 256)       0         
_________________________________________________________________
block4_conv1 (Conv2D)        (None, 18, 18, 512)       1180160   
_________________________________________________________________
block4_conv2 (Conv2D)        (None, 18, 18, 512)       2359808   
_________________________________________________________________
block4_conv3 (Conv2D)        (None, 18, 18, 512)       2359808   
_________________________________________________________________
block4_pool (MaxPooling2D)   (None, 9, 9, 512)         0         
_________________________________________________________________
block5_conv1 (Conv2D)        (None, 9, 9, 512)         2359808   
=================================================================
Total params: 9,995,072
Trainable params: 9,995,072
Non-trainable params: 0
_________________________________________________________________
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">layer_names_large</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['input_1',
 'block1_conv1',
 'block1_conv2',
 'block1_pool',
 'block2_conv1',
 'block2_conv2',
 'block2_pool',
 'block3_conv1',
 'block3_conv2',
 'block3_conv3',
 'block3_pool',
 'block4_conv1',
 'block4_conv2',
 'block4_conv3',
 'block4_pool',
 'block5_conv1']
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">run_all</span><span class="p">(</span><span class="n">activation_model_large</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"--- </span><span class="si">%</span><span class="s">s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Layer name: block4_conv1
Output shape: (None, 18, 18, 512)
Training shape: (8000, 165888)
The accuracy is: 0.847
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<hr />

<p>Let’s plot our results again:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">acc</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'acc'</span><span class="p">]</span>
<span class="n">val_acc</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_acc'</span><span class="p">]</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'loss'</span><span class="p">]</span>
<span class="n">val_loss</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_loss'</span><span class="p">]</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acc</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="s">'bo'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Training acc'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">val_acc</span><span class="p">,</span> <span class="s">'b'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Validation acc'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Training and validation accuracy'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="s">'bo'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Training loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">epochs</span><span class="p">,</span> <span class="n">val_loss</span><span class="p">,</span> <span class="s">'b'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Validation loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Training and validation loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p>Thanks to data augmentation and dropout, we are no longer overfitting: the training curves are rather closely tracking the validation 
curves. We are now able to reach an accuracy of 82%, a 15% relative improvement over the non-regularized model.</p>

<p>By leveraging regularization techniques even further and by tuning the network’s parameters (such as the number of filters per convolution 
layer, or the number of layers in the network), we may be able to get an even better accuracy, likely up to 86-87%. However, it would prove 
very difficult to go any higher just by training our own convnet from scratch, simply because we have so little data to work with. As a 
next step to improve our accuracy on this problem, we will have to leverage a pre-trained model, which will be the focus of the next two 
sections.</p>

  </div><a class="u-url" href="/2020/04/16/5.2-using-convnets-with-small-datasets-local-modified.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <!--
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        -->
        <ul class="contact-list">
          <li class="p-name">Code And Stats</li>
          <li><a class="u-email" href="mailto:codeandstats@hwr-berlin.de">codeandstats@hwr-berlin.de</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
